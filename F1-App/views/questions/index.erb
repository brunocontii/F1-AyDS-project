<!DOCTYPE html>
<html>
<head>
    <title>Questions</title>
    <link rel="icon" href="icon-1-50.png">
    <link rel="stylesheet" href="/stylePilot.css">
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            let timeLeft = 15;
            const timerElement = document.getElementById('timer-bar');
            const formElement = document.getElementById('question-form');

            const countdown = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    handleTimeOut(); // Handle timeout scenario
                } else {
                    const percentage = (timeLeft / 15) * 100;
                    timerElement.style.width = `${percentage}%`;

                    if (timeLeft > 10) {
                        timerElement.style.backgroundColor = 'green';
                    } else if (timeLeft > 5) {
                        timerElement.style.backgroundColor = 'yellow';
                    } else if (timeLeft > 2) {
                        timerElement.style.backgroundColor = 'orange';
                    } else {
                        timerElement.style.backgroundColor = 'red';
                    }
                }
                timeLeft -= 1;
            }, 1000);

            function handleTimeOut() {
                document.getElementById('timeout').value = 'true';
                formElement.submit();
            }
        });
    </script>
</head>
<body>
<header>
    <div class="left">
        <a href="/gamemodes" class="menu-item" data-lang-key="back">Back</a>
    </div>
    <div class="right">
        <div class="user-info">
            <div class="currency">
                <img src="/coin.png" alt="Monedas" class="icon">
                <span><%= @current_user ? @current_user.cant_coins : 0 %></span>
            </div>
            <div class="lives">
                <img src="/heart.png" alt="Vidas" class="icon">
                <span><%= @current_user ? @current_user.cant_life : 0 %></span>
            </div>
            <div class="profile">
                <img src="/pilot.png" alt="Profile" class="profile-pic" onclick="toggleProfileMenu()">
                <div id="profile-menu" class="profile-menu">
                    <a href="/profile" data-lang-key="profile">Profile</a>
                    <div class="change-language" onclick="toggleLanguage()">
                        <span data-lang-key="changeLanguage">Change Language</span>
                        <img src="/argentina.png" alt="Idioma" class="language-flag">
                    </div>
                    <a href="/logout" data-lang-key="logout">Log out</a>
                </div>
            </div>
        </div>
    </div>
</header>
<main>
    <% if session[:message] %>
        <div class="feedback-message" style="color: <%= session[:color] %>;">
            <p><%= session[:message] %></p>
        </div>
        <% session.delete(:message) %>
        <% session.delete(:color) %>
    <% end %>
    
    <div class="question-container">
        <% if feedback_message %>
            <div class="feedback-message" style="color: <%= feedback_color %>;">
                <p><%= feedback_message %></p>
                <form action="<%= @form_action %>" method="get">
                    <button type="submit" class="next-button">Next</button>
                </form>
            </div>
        <% else %>
            <div class="timer">
                <div id="timer-bar"></div>
            </div>
            <h2 class="question-title"><%= @question.name_question %></h2>
            <form id="question-form" action="<%= @form_action %>" method="post" class="question-form">
                <% @options.each do |option| %>
                    <div class="option">
                        <input type="radio" id="option_<%= option.id %>" name="option_id" value="<%= option.id %>" class="option-input">
                        <label for="option_<%= option.id %>" class="option-label"><%= option.name_option %></label>
                    </div>
                <% end %>
                <input type="hidden" name="timeout" id="timeout" value="false">
                <input type="hidden" name="question_id" value="<%= @question.id %>">
                <button type="submit" class="submit-button">Check Answer</button>
            </form>
        <% end %>
    </div>
</main>
<script>
function toggleProfileMenu() {
    var menu = document.getElementById('profile-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function toggleLanguage() {
    var currentFlag = document.querySelector('.language-flag');
    var newLang = currentFlag.src.includes('argentina.png') ? 'en' : 'es';
    var newFlag = newLang === 'en' ? 'usa.png' : 'argentina.png';
    currentFlag.src = newFlag;

    updateLanguage(newLang);
}

function updateLanguage(lang) {
    const elements = document.querySelectorAll('[data-lang-key]');
    elements.forEach(el => {
        const key = el.getAttribute('data-lang-key');
        el.textContent = translations[lang][key];
    });
}
</script>
</body>
</html>
